<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Player</title>
    <link rel="icon" type="image/png" href="Audio_Player_Icon.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f0f13 0%, #1a1a24 100%);
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-tertiary: rgba(255, 255, 255, 0.4);
            --accent-color: #7b61ff;
            --accent-hover: #9378ff;
            --control-bg: rgba(255, 255, 255, 0.05);
            --control-active: rgba(123, 97, 255, 0.2);
            --progress-bg: rgba(255, 255, 255, 0.1);
            --progress-fill: var(--accent-color);
            --transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
            --border-radius: 12px;
            --border-radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .player-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: 100vh;
            width: 100vw;
        }

        .album-art-container {
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #2a2a3a 0%, #1a1a24 100%);
        }

        .album-art {
            width: 80%;
            height: 80%;
            object-fit: contain;
            border-radius: var(--border-radius);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.3);
            transition: var(--transition);
            z-index: 2;
        }

        .album-art-blur {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(30px) brightness(0.6);
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 1;
        }

        .album-art-placeholder {
            width: 40%;
            height: 40%;
            opacity: 0.2;
            position: absolute;
            z-index: 1;
        }

        .player-content {
            padding: 40px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .player-header {
            margin-bottom: 40px;
        }

        .player-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .player-title svg {
            width: 24px;
            height: 24px;
            fill: var(--accent-color);
        }

        .now-playing {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .track-info {
            margin-bottom: 16px;
        }

        .track-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            font-size: 24px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .track-album {
            font-size: 18px;
            color: var(--text-tertiary);
        }

        .progress-container {
            width: 100%;
            margin: 24px 0;
        }

        .progress-bar {
            height: 6px;
            width: 100%;
            background: var(--progress-bg);
            border-radius: 3px;
            cursor: pointer;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--progress-fill);
            border-radius: 3px;
            transition: width 0.1s linear;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            transition: var(--transition);
        }

        .progress-bar:hover .progress-fill::after {
            opacity: 1;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-tertiary);
        }

        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 24px 0;
        }

        .control-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--control-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            color: var(--text-primary);
        }

        .control-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.98);
        }

        .control-btn.active {
            background: var(--control-active);
            color: var(--accent-color);
        }

        .play-btn {
            width: 72px;
            height: 72px;
            background: var(--accent-color);
            color: white;
        }

        .play-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .play-btn svg {
            width: 32px;
            height: 32px;
        }

        .secondary-controls {
            display: flex;
            justify-content: center;
            margin-top: 3px;
        }

        .playback-speed {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
        }

        .speed-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 16px;
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
        }

        .speed-btn.active {
            background: var(--control-active);
            color: var(--accent-color);
        }

        .playlist-container {
            margin-top: 100px;
            flex-grow: 1;
            height: 100vh;
            overflow-y: 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius);
            position: relative;
        }

        .playlist-header {
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: rgba(20, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .playlist-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .playlist-title svg {
            width: 18px;
            height: 18px;
            fill: var(--accent-color);
        }

        .playlist-actions {
            display: flex;
            gap: 12px;
        }

        .playlist-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            padding: 4px;
            border-radius: 4px;
        }

        .playlist-action-btn:hover {
            color: var(--accent-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .playlist-action-btn svg {
            width: 18px;
            height: 18px;
        }

        .playlist-count {
            font-size: 14px;
            color: var(--text-tertiary);
            background: rgba(123, 97, 255, 0.1);
            padding: 4px 8px;
            border-radius: 20px;
        }

        .playlist {
            padding: 8px 0;
        }

        .playlist-item {
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .playlist-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .playlist-item.active {
            background: rgba(123, 97, 255, 0.1);
        }

        .playlist-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-color);
            border-radius: 0 3px 3px 0;
        }

        .playlist-item-art {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .playlist-item-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-item-art svg {
            width: 20px;
            height: 20px;
            opacity: 0.3;
        }

        .playlist-item-info {
            flex-grow: 1;
            min-width: 0;
        }

        .playlist-item-title {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }

        .playlist-item-artist {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-duration {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-left: 16px;
            flex-shrink: 0;
        }

        .playlist-item-now-playing {
            width: 16px;
            height: 16px;
            margin-left: 8px;
            flex-shrink: 0;
            display: none;
        }

        .playlist-item.active .playlist-item-now-playing {
            display: block;
        }

        .playlist-empty {
            padding: 60px 24px;
            text-align: center;
            color: var(--text-tertiary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .playlist-empty-icon {
            width: 48px;
            height: 48px;
            opacity: 0.3;
        }

        .playlist-empty-text {
            font-size: 15px;
            max-width: 240px;
            line-height: 1.5;
        }

        .playlist-empty-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 500;
            margin-top: 8px;
            transition: var(--transition);
        }

        .playlist-empty-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .file-input-container {
            display: none;
        }

        .playlist-load-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 15, 19, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
            padding: 24px;
            overflow-y: auto;
        }

        .playlist-load-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .playlist-load-header h3 {
            font-size: 18px;
            font-weight: 500;
        }

        .playlist-load-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .playlist-load-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius-sm);
            padding: 16px;
            cursor: pointer;
            transition: var(--transition);
        }

        .playlist-load-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .playlist-load-item h4 {
            font-size: 15px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-load-item p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .playlist-load-item-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 8px;
        }

        .playlist-load-item-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px;
            border-radius: 4px;
        }

        .playlist-load-item-btn:hover {
            color: var(--accent-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .playlist-load-item-btn svg {
            width: 16px;
            height: 16px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .playing .album-art {
            animation: pulse 8s infinite ease-in-out;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 1024px) {
            .player-container {
                grid-template-columns: 1fr;
                height: auto;
                min-height: 100vh;
            }
            
            .album-art-container {
                height: 60vh;
            }
            
            .player-content {
                padding: 24px;
            }
            
            .track-title {
                font-size: 24px;
            }
            
            .track-artist {
                font-size: 18px;
            }
        }

        @media (max-width: 768px) {
            .album-art {
                width: 90%;
                height: 90%;
            }
            
            .player-controls {
                gap: 12px;
            }
            
            .control-btn {
                width: 48px;
                height: 48px;
            }
            
            .play-btn {
                width: 64px;
                height: 64px;
            }
        }
    </style>
</head>
<body>
    <div class="player-container">
        <div class="album-art-container">
            <div class="album-art-blur" id="album-art-blur"></div>
            <img class="album-art" id="album-art" src="" alt="Album Art" title="Click to add music" tabindex="0" aria-label="Album Art (click to add music)">
            <svg class="album-art-placeholder" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 18V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                <path d="M16 18V6"></path>
                <path d="M8 18V6"></path>
                <path d="M3 12h18"></path>
            </svg>
            <div class="file-input-container">
                <input type="file" id="file-input" accept=".mp3,audio/*" multiple>
            </div>
        </div>

        <div class="player-content">
            <div class="player-header">
                <h1 class="player-title">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                    </svg>
                    Player
                </h1>
            </div>

            <div class="now-playing">
                <div class="track-info">
                    <h2 class="track-title" id="current-title">No track selected</h2>
                    <p class="track-artist" id="current-artist">—</p>
                    <p class="track-album" id="current-album">—</p>
                </div>

                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar" title="Seek (click or drag)" tabindex="0" aria-label="Seek bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="time-display">
                        <span id="current-time">0:00</span>
                        <span id="duration">0:00</span>
                    </div>
                </div>

                <div class="player-controls">
                    <button class="control-btn" id="shuffle-btn" title="Shuffle">
                        <svg viewBox="0 0 24 24">
                            <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
                        </svg>
                    </button>
                    <button class="control-btn" id="prev-btn" title="Previous">
                        <svg viewBox="0 0 24 24">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                        </svg>
                    </button>
                    <button class="control-btn play-btn" id="play-btn" title="Play (Space)" aria-label="Play/Pause (Space)">
                        <svg viewBox="0 0 24 24" id="play-icon">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    </button>
                    <button class="control-btn" id="next-btn" title="Next">
                        <svg viewBox="0 0 24 24">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                        </svg>
                    </button>
                    <button class="control-btn" id="repeat-btn" title="Repeat">
                        <svg viewBox="0 0 24 24">
                            <path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/>
                        </svg>
                    </button>
                </div>

                <div class="secondary-controls">
                    <div class="playback-speed">
                        <button class="speed-btn" data-speed="0.5">0.5x</button>
                        <button class="speed-btn" data-speed="0.75">0.75x</button>
                        <button class="speed-btn active" data-speed="1.0">1.0x</button>
                        <button class="speed-btn" data-speed="1.25">1.25x</button>
                        <button class="speed-btn" data-speed="1.5">1.5x</button>
                        <button class="speed-btn" data-speed="2.0">2.0x</button>
                    </div>
                    <div style="margin-left:20px;color:var(--text-tertiary);font-size:13px;">
                        <span title="Keyboard Shortcuts">
                            ␣ Play/Pause &nbsp;⏮ P &nbsp;⏭ N &nbsp;⏫/⏬ Vol &nbsp;M Mute &nbsp;S Shuffle &nbsp;R Repeat
                        </span>
                    </div>
                </div>
            </div>

            <div class="playlist-container">
                <div class="playlist-header">
                    <div class="playlist-title">
                        <svg viewBox="0 0 24 24">
                            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
                        </svg>
                        Playlist
                        <span class="playlist-count" id="playlist-count">0</span>
                    </div>
                    <div class="playlist-actions">
                        <button class="playlist-action-btn" id="clear-playlist" title="Clear playlist">
                            <svg viewBox="0 0 24 24">
                                <path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14zM6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z"/>
                            </svg>
                        </button>
                        <button class="playlist-action-btn" id="shuffle-playlist" title="Shuffle playlist">
                            <svg viewBox="0 0 24 24">
                                <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="playlist" id="playlist">
                    <div class="playlist-empty">
                        <svg class="playlist-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 18V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <path d="M16 18V6"></path>
                            <path d="M8 18V6"></path>
                            <path d="M3 12h18"></path>
                        </svg>
                        <div class="playlist-empty-text">Your playlist is empty. Add some music to get started.</div>
                        <button class="playlist-empty-btn" id="add-music-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Add Music
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const audioPlayer = new Audio();
        const fileInput = document.getElementById('file-input');
        const playBtn = document.getElementById('play-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressFill = document.getElementById('progress-fill');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');
        const currentTitle = document.getElementById('current-title');
        const currentArtist = document.getElementById('current-artist');
        const currentAlbum = document.getElementById('current-album');
        const playlistElement = document.getElementById('playlist');
        const playlistCount = document.getElementById('playlist-count');
        const albumArt = document.getElementById('album-art');
        const albumArtBlur = document.getElementById('album-art-blur');
        const speedButtons = document.querySelectorAll('.speed-btn');
        const playerContainer = document.querySelector('.player-container');
        const clearPlaylistBtn = document.getElementById('clear-playlist');
        const shufflePlaylistBtn = document.getElementById('shuffle-playlist');
        const addMusicBtn = document.getElementById('add-music-btn');
        const muteBtn = document.getElementById('mute-btn');
        const muteIcon = document.getElementById('mute-icon');
        const volumeSlider = document.getElementById('volume-slider');

        // Player State
        let playlistItems = [];
        let currentIndex = -1;
        let isPlaying = false;
        let isShuffled = false;
        let repeatMode = 'off';
        let originalPlaylistOrder = [];
        let isDraggingProgress = false;

        // Initialize
        setupEventListeners();

        function setupEventListeners() {
            // File input
            albumArt.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelection);
            addMusicBtn.addEventListener('click', () => fileInput.click());

            // Player controls
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrevious);
            nextBtn.addEventListener('click', playNext);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);

            // Playlist actions
            clearPlaylistBtn.addEventListener('click', clearPlaylist);
            shufflePlaylistBtn.addEventListener('click', shufflePlaylist);

            // Progress bar
            progressBar.addEventListener('click', seek);
            progressBar.addEventListener('mousedown', () => isDraggingProgress = true);
            document.addEventListener('mousemove', handleProgressDrag);
            document.addEventListener('mouseup', () => isDraggingProgress = false);

            // Playback speed
            speedButtons.forEach(btn => {
                btn.addEventListener('click', () => setPlaybackSpeed(parseFloat(btn.dataset.speed)));
            });

            // Audio player events
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', handleTrackEnd);
            audioPlayer.addEventListener('play', () => {
                isPlaying = true;
                updatePlayButton();
                playerContainer.classList.add('playing');
            });
            audioPlayer.addEventListener('pause', () => {
                isPlaying = false;
                updatePlayButton();
                playerContainer.classList.remove('playing');
            });
            audioPlayer.addEventListener('loadedmetadata', updateDuration);

            // Volume control
            volumeSlider.addEventListener('input', (e) => {
                audioPlayer.volume = parseFloat(e.target.value);
                audioPlayer.muted = audioPlayer.volume === 0;
                updateMuteIcon();
            });
            audioPlayer.addEventListener('volumechange', updateMuteIcon);

            // Mute button
            muteBtn.addEventListener('click', toggleMute);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Accessibility: Album art and progress bar
            albumArt.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    fileInput.click();
                }
            });
            progressBar.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                } else if (e.key === 'ArrowRight') {
                    audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                }
            });
        }

        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;
            
            // Clear empty message if it exists
            const emptyMessage = playlistElement.querySelector('.playlist-empty');
            if (emptyMessage && files.length > 0) {
                playlistElement.removeChild(emptyMessage);
            }
            
            // Process each file
            files.forEach(file => {
                if (!file.type.includes('audio')) return;
                
                const playlistItem = createPlaylistItem(file);
                playlistElement.appendChild(playlistItem);
                
                // Read metadata with jsmediatags
                readAudioMetadata(file).then(metadata => {
                    playlistItems.push({ file, metadata });
                    updatePlaylistItem(playlistItem, metadata);
                    updatePlaylistCount();
                    
                    // Auto-play first file if nothing is playing
                    if (currentIndex === -1 && playlistItems.length === 1) {
                        playFile(0);
                    }
                }).catch(error => {
                    console.error('Error reading metadata:', error);
                    // Fallback with basic metadata
                    const fallbackMetadata = {
                        title: file.name.replace(/\.[^/.]+$/, ""),
                        artist: 'Unknown Artist',
                        album: 'Unknown Album',
                        picture: null,
                        duration: 0
                    };
                    playlistItems.push({ file, metadata: fallbackMetadata });
                    updatePlaylistItem(playlistItem, fallbackMetadata);
                    updatePlaylistCount();
                });
            });
        }

        function createPlaylistItem(file, metadata = null) {
            const playlistItem = document.createElement('div');
            playlistItem.className = 'playlist-item';
            
            playlistItem.innerHTML = `
                <div class="playlist-item-art">
                    ${metadata?.picture ? 
                        `<img src="${URL.createObjectURL(new Blob([new Uint8Array(metadata.picture.data)], { type: metadata.picture.format }))}" alt="Album Art">` :
                        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 18V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <path d="M16 18V6"></path>
                            <path d="M8 18V6"></path>
                            <path d="M3 12h18"></path>
                        </svg>`
                    }
                </div>
                <div class="playlist-item-info">
                    <div class="playlist-item-title">${metadata?.title || file.name.replace(/\.[^/.]+$/, "")}</div>
                    <div class="playlist-item-artist">${metadata?.artist || 'Unknown Artist'}</div>
                </div>
                <div class="playlist-item-duration">${metadata?.duration ? formatTime(metadata.duration) : '--:--'}</div>
                <div class="playlist-item-now-playing">
                    <svg viewBox="0 0 24 24" fill="var(--accent-color)">
                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                    </svg>
                </div>
            `;
            
            playlistItem.addEventListener('click', () => {
                const index = Array.from(playlistElement.children).indexOf(playlistItem);
                playFile(index);
            });
            
            return playlistItem;
        }

        function updatePlaylistItem(item, metadata) {
            const titleEl = item.querySelector('.playlist-item-title');
            const artistEl = item.querySelector('.playlist-item-artist');
            const durationEl = item.querySelector('.playlist-item-duration');
            const artEl = item.querySelector('.playlist-item-art');
            
            titleEl.textContent = metadata.title || 'Unknown Track';
            artistEl.textContent = metadata.artist || 'Unknown Artist';
            durationEl.textContent = formatTime(metadata.duration || 0);
            
            // Update album art in playlist
            if (metadata.picture) {
                const imageUrl = URL.createObjectURL(new Blob([new Uint8Array(metadata.picture.data)], { type: metadata.picture.format }));
                artEl.innerHTML = `<img src="${imageUrl}" alt="Album Art">`;
            } else {
                artEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 18V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <path d="M16 18V6"></path>
                    <path d="M8 18V6"></path>
                    <path d="M3 12h18"></path>
                </svg>`;
            }
        }

        function readAudioMetadata(file) {
            return new Promise((resolve, reject) => {
                jsmediatags.read(file, {
                    onSuccess: function(tag) {
                        const metadata = {
                            title: tag.tags.title || file.name.replace(/\.[^/.]+$/, ""),
                            artist: tag.tags.artist || 'Unknown Artist',
                            album: tag.tags.album || 'Unknown Album',
                            duration: 0, // Will be updated when audio loads
                            picture: tag.tags.picture
                        };
                        
                        // Get duration
                        const audio = new Audio();
                        audio.src = URL.createObjectURL(file);
                        audio.addEventListener('loadedmetadata', () => {
                            metadata.duration = audio.duration;
                            audio.remove();
                            resolve(metadata);
                        });
                        
                        setTimeout(() => {
                            if (!metadata.duration) {
                                audio.remove();
                                resolve(metadata); // Fallback if duration takes too long
                            }
                        }, 2000);
                    },
                    onError: function(error) {
                        reject(error);
                    }
                });
            });
        }

        function playFile(index) {
            if (index < 0 || index >= playlistItems.length) return;
            
            currentIndex = index;
            const { file, metadata } = playlistItems[index];
            
            // Update UI
            currentTitle.textContent = metadata.title || file.name;
            currentArtist.textContent = metadata.artist || 'Unknown Artist';
            currentAlbum.textContent = metadata.album || 'Unknown Album';
            
            // Update album art
            updateAlbumArt(metadata.picture);
            
            // Update active item in playlist
            const items = playlistElement.querySelectorAll('.playlist-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // Play the file
            audioPlayer.src = URL.createObjectURL(file);
            audioPlayer.play();
        }

        function updateAlbumArt(picture) {
            if (picture) {
                const imageUrl = URL.createObjectURL(new Blob([new Uint8Array(picture.data)], { type: picture.format }));
                albumArt.src = imageUrl;
                albumArt.style.display = 'block';
                albumArtBlur.style.backgroundImage = `url(${imageUrl})`;
                albumArtBlur.style.opacity = '1';
            } else {
                albumArt.src = '';
                albumArt.style.display = 'none';
                albumArtBlur.style.opacity = '0';
            }
        }

        function togglePlay() {
            if (audioPlayer.src) {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                } else {
                    audioPlayer.pause();
                }
            } else if (playlistItems.length > 0) {
                playFile(0);
            }
        }

        function playPrevious() {
            if (playlistItems.length === 0) return;
            
            let newIndex = currentIndex - 1;
            if (newIndex < 0) {
                newIndex = playlistItems.length - 1;
            }
            playFile(newIndex);
        }

        function playNext() {
            if (playlistItems.length === 0) return;
            
            let newIndex = currentIndex + 1;
            if (newIndex >= playlistItems.length) {
                newIndex = 0;
            }
            playFile(newIndex);
        }

        function toggleShuffle() {
            isShuffled = !isShuffled;
            shuffleBtn.classList.toggle('active', isShuffled);
            
            if (isShuffled) {
                originalPlaylistOrder = [...playlistItems];
                shuffleArray(playlistItems);
            } else if (originalPlaylistOrder.length > 0) {
                playlistItems = [...originalPlaylistOrder];
            }
            
            rebuildPlaylistUI();
        }

        function toggleRepeat() {
            const modes = ['off', 'one', 'all'];
            const currentModeIndex = modes.indexOf(repeatMode);
            repeatMode = modes[(currentModeIndex + 1) % modes.length];
            
            repeatBtn.classList.remove('active');
            if (repeatMode !== 'off') {
                repeatBtn.classList.add('active');
            }
            
            // Update tooltip
            repeatBtn.title = `Repeat ${repeatMode === 'one' ? 'One' : repeatMode === 'all' ? 'All' : 'Off'}`;
        }

        function clearPlaylist() {
            playlistItems = [];
            currentIndex = -1;
            rebuildPlaylistUI();
            updatePlaylistCount();
            
            // Clear current playback
            audioPlayer.src = '';
            audioPlayer.pause();
            currentTitle.textContent = 'No track selected';
            currentArtist.textContent = '—';
            currentAlbum.textContent = '—';
            albumArt.src = '';
            albumArtBlur.style.opacity = '0';
            
            // Show empty state
            playlistElement.innerHTML = `
                <div class="playlist-empty">
                    <svg class="playlist-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 18V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <path d="M16 18V6"></path>
                        <path d="M8 18V6"></path>
                        <path d="M3 12h18"></path>
                    </svg>
                    <div class="playlist-empty-text">Your playlist is empty. Add some music to get started.</div>
                    <button class="playlist-empty-btn" id="add-music-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Music
                    </button>
                </div>
            `;
            
            // Reattach event listener
            document.getElementById('add-music-btn').addEventListener('click', () => fileInput.click());
        }

        function shufflePlaylist() {
            if (playlistItems.length === 0) return;
            
            // Save current track to maintain it after shuffle
            const currentTrack = currentIndex >= 0 ? playlistItems[currentIndex] : null;
            
            // Shuffle the playlist
            if (!isShuffled) {
                originalPlaylistOrder = [...playlistItems];
            }
            shuffleArray(playlistItems);
            isShuffled = true;
            shuffleBtn.classList.add('active');
            
            // Find and set the new index of the current track
            if (currentTrack) {
                currentIndex = playlistItems.findIndex(item => item.file === currentTrack.file);
            }
            
            rebuildPlaylistUI();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function rebuildPlaylistUI() {
            playlistElement.innerHTML = '';
            
            if (playlistItems.length === 0) {
                playlistElement.innerHTML = `
                    <div class="playlist-empty">
                        <svg class="playlist-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 18V6a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <path d="M16 18V6"></path>
                            <path d="M8 18V6"></path>
                            <path d="M3 12h18"></path>
                        </svg>
                        <div class="playlist-empty-text">Your playlist is empty. Add some music to get started.</div>
                        <button class="playlist-empty-btn" id="add-music-btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            Add Music
                        </button>
                    </div>
                `;
                document.getElementById('add-music-btn').addEventListener('click', () => fileInput.click());
                return;
            }
            
            playlistItems.forEach((item, index) => {
                const playlistItem = createPlaylistItem(item.file, item.metadata);
                if (index === currentIndex) {
                    playlistItem.classList.add('active');
                }
                playlistElement.appendChild(playlistItem);
            });
        }

        function updateProgress() {
            if (isDraggingProgress) return;
            
            const { currentTime, duration } = audioPlayer;
            const progressPercent = (currentTime / duration) * 100 || 0;
            progressFill.style.width = `${progressPercent}%`;
            currentTimeDisplay.textContent = formatTime(currentTime);
        }

        function updateDuration() {
            durationDisplay.textContent = formatTime(audioPlayer.duration);
            
            // Update duration in playlist item
            if (currentIndex >= 0) {
                playlistItems[currentIndex].metadata.duration = audioPlayer.duration;
                const items = playlistElement.querySelectorAll('.playlist-item');
                if (items[currentIndex]) {
                    items[currentIndex].querySelector('.playlist-item-duration').textContent = formatTime(audioPlayer.duration);
                }
            }
        }

        function seek(e) {
            const progressBarWidth = progressBar.clientWidth;
            const clickPosition = e.offsetX;
            const seekTime = (clickPosition / progressBarWidth) * audioPlayer.duration;
            audioPlayer.currentTime = seekTime;
        }

        function handleProgressDrag(e) {
            if (!isDraggingProgress) return;
            
            const progressBarRect = progressBar.getBoundingClientRect();
            const clickPosition = Math.min(Math.max(e.clientX - progressBarRect.left, 0), progressBarRect.width);
            const seekTime = (clickPosition / progressBarRect.width) * audioPlayer.duration;
            audioPlayer.currentTime = seekTime;
            progressFill.style.width = `${(clickPosition / progressBarRect.width) * 100}%`;
            currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);
        }

        function handleTrackEnd() {
            if (repeatMode === 'one') {
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else if (repeatMode === 'all' || isShuffled) {
                playNext();
            } else if (currentIndex < playlistItems.length - 1) {
                playNext();
            }
        }

        function updatePlayButton() {
            const playIcon = playBtn.querySelector('svg');
            if (isPlaying) {
                playIcon.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
                playBtn.title = 'Pause';
            } else {
                playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
                playBtn.title = 'Play';
            }
        }

        function setPlaybackSpeed(speed) {
            audioPlayer.playbackRate = speed;
            
            // Update active speed button
            speedButtons.forEach(btn => {
                btn.classList.toggle('active', parseFloat(btn.dataset.speed) === speed);
            });
        }

        function updatePlaylistCount() {
            const count = playlistItems.length;
            playlistCount.textContent = count;
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        function toggleMute() {
            audioPlayer.muted = !audioPlayer.muted;
            updateMuteIcon();
        }

        function updateMuteIcon() {
            if (audioPlayer.muted || audioPlayer.volume === 0) {
                muteIcon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03V7.5c0-.83-.67-1.5-1.5-1.5S11 6.67 11 7.5v9c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-0.47c1.48-.74 2.5-2.26 2.5-4.03z"/><line x1="19" y1="5" x2="5" y2="19" stroke="currentColor" stroke-width="2"/>';
                muteBtn.classList.add('active');
            } else {
                muteIcon.innerHTML = '<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03V7.5c0-.83-.67-1.5-1.5-1.5S11 6.67 11 7.5v9c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-0.47c1.48-.74 2.5-2.26 2.5-4.03z"/>';
                muteBtn.classList.remove('active');
            }
            volumeSlider.value = audioPlayer.muted ? 0 : audioPlayer.volume;
        }

        function handleKeyboardShortcuts(e) {
            if (e.target.tagName === 'INPUT') return;
            
            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlay();
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    audioPlayer.volume = Math.min(1, audioPlayer.volume + 0.1);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    audioPlayer.volume = Math.max(0, audioPlayer.volume - 0.1);
                    break;
                case 'm':
                    e.preventDefault();
                    toggleMute();
                    break;
                case 's':
                    e.preventDefault();
                    toggleShuffle();
                    break;
                case 'r':
                    e.preventDefault();
                    toggleRepeat();
                    break;
                case 'n':
                    e.preventDefault();
                    playNext();
                    break;
                case 'p':
                    e.preventDefault();
                    playPrevious();
                    break;
            }
        }
    </script>
</body>
</html>
